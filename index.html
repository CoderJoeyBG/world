<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>World Ping Map</title>
  <meta name="description" content="A GitHub Pages‑friendly, single‑file world map that flashes at the visitor's location and logs pings by country." />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#dbe4ff; --muted:#8aa0c7; --accent:#4cc9f0; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    #app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    header{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));backdrop-filter:saturate(1.1)}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    .badge{font-size:12px;color:var(--bg);background:var(--accent);padding:2px 8px;border-radius:999px}

    #layout{display:grid;grid-template-columns:1fr 360px;gap:12px;padding:12px}
    @media (max-width: 980px){#layout{grid-template-columns:1fr}} 

    #map{height:calc(100vh - 160px);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.06)}

    .panel{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px;display:flex;flex-direction:column;gap:10px}
    .stat{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;background:#0e1628;border:1px solid rgba(255,255,255,.06)}
    .muted{color:var(--muted);font-size:12px}
    .list{overflow:auto;max-height:420px;}
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;background:#0a1323;border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,.06)}

    /* Pulse marker */
    .pulse{
      width:16px;height:16px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 0 rgba(76,201,240,.7);
      animation:pulse 1.4s ease-out 1;
      border:2px solid white
    }
    @keyframes pulse{
      0%{transform:scale(.6);box-shadow:0 0 0 0 rgba(76,201,240,.7)}
      70%{transform:scale(1.7);box-shadow:0 0 0 14px rgba(76,201,240,0)}
      100%{transform:scale(1);box-shadow:0 0 0 0 rgba(76,201,240,0)}
    }
    .leaflet-container{background:#06101f}
    .leaflet-control-attribution{display:none}
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>World Ping Map <span class="badge">Live</span></h1>
  </header>

  <div id="layout">
    <div id="map"></div>

    <aside class="panel">
      <div class="stat"><strong>Total Pings</strong><span id="totalPings">0</span></div>
      <div class="stat"><strong>Unique Countries</strong><span id="uniqueCountries">0</span></div>
      <div class="stat"><strong>Your Country</strong><span id="yourCountry" class="muted">—</span></div>

      <div>
        <div class="muted" style="margin:8px 2px 6px">Top Countries (this session)</div>
        <div id="topCountries" class="list"></div>
      </div>

      <div>
        <div class="muted" style="margin:8px 2px 6px">Recent Pings</div>
        <div id="log" class="list"></div>
      </div>

      <p class="muted" style="margin-top:6px">Note: This single-file page is static. Each visitor sees live flashes when they arrive. For global, real‑time aggregation across all visitors, plug in any realtime backend (e.g., Firebase, Supabase) by sending visitor geo to it and broadcasting updates—hooks included in code.</p>
    </aside>
  </div>

  <footer style="padding:10px 16px" class="muted">Built with Leaflet, IP geolocation via <a href="https://ipwho.is" target="_blank" rel="noopener" style="color:var(--accent)">ipwho.is</a>. No cookies; data stays in your session.</footer>
</div>

<script>
  const map = L.map('map', { zoomControl: true }).setView([20, 0], 2.2)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 6,
    minZoom: 2,
  }).addTo(map)

  const pingLayer = L.layerGroup().addTo(map)
  let lastPingLatLng = null

  const el = id => document.getElementById(id)
  const totalPingsEl = el('totalPings')
  const uniqueCountriesEl = el('uniqueCountries')
  const yourCountryEl = el('yourCountry')
  const topCountriesEl = el('topCountries')
  const logEl = el('log')

  const state = {
    total: 0,
    byCountry: new Map(),
    recent: []
  }

  function formatTime(ts){
    return new Date(ts).toLocaleTimeString(undefined, { hour:'2-digit', minute:'2-digit', second:'2-digit' })
  }

  function updateStats(){
    totalPingsEl.textContent = state.total
    uniqueCountriesEl.textContent = state.byCountry.size

    const arr = Array.from(state.byCountry.entries()).sort((a,b)=>b[1].count - a[1].count).slice(0,10)
    topCountriesEl.innerHTML = arr.map(([code, info])=>`<div class="stat"><span>${info.flag} ${info.name}</span><span>${info.count}</span></div>`).join('') || '<div class="muted">No data yet</div>'

    logEl.innerHTML = state.recent.slice(-12).reverse().map(i=>
      `<div class="log">${i.flag} <strong>${i.country}</strong> · ${i.city || '—'} · ${i.ip} · ${formatTime(i.ts)}</div>`
    ).join('')
  }

  function flagEmoji(countryCode){
    if(!countryCode) return '🏳️'
    const codePoints = countryCode.toUpperCase().split('').map(c => 127397 + c.charCodeAt())
    return String.fromCodePoint(...codePoints)
  }

  function addPing({lat, lon, country, country_code, city, ip, focus=true}){
    const latLng = [lat, lon]
    lastPingLatLng = latLng
    state.total += 1

    const code = country_code || 'UN'
    const name = country || 'Unknown'
    const flag = flagEmoji(code)

    const entry = state.byCountry.get(code) || { name, flag, count:0 }
    entry.count += 1
    state.byCountry.set(code, entry)

    state.recent.push({ country:name, flag, city, ip, ts: Date.now() })

    const div = L.divIcon({ className:'', html:'<div class="pulse" title="'+name+'"></div>', iconSize:[16,16], iconAnchor:[8,8] })
    const marker = L.marker(latLng, { icon: div, zIndexOffset: 9999 }).addTo(pingLayer)

    setTimeout(()=> pingLayer.removeLayer(marker), 1600)

    updateStats()
    if(focus){ map.flyTo(latLng, Math.max(map.getZoom(), 3), { duration: .8 }) }
  }

  async function fetchVisitorGeo(){
    try {
      const r = await fetch('https://ipwho.is/')
      const j = await r.json()
      if(!j.success) throw new Error('geo failed')
      const data = { lat:j.latitude, lon:j.longitude, country:j.country, country_code:j.country_code, city:j.city, ip:j.ip }
      yourCountryEl.textContent = `${flagEmoji(j.country_code)} ${j.country}`
      addPing(data)
      // Hook: send to your backend here if you add one
    } catch (e){
      yourCountryEl.textContent = 'Unable to detect location'
      console.error(e)
    }
  }

  fetchVisitorGeo()
</script>
</body>
</html>
