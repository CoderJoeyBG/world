<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>World Ping Map - Live</title>
  <meta name="description" content="Realtime world ping map using Firebase Realtime Database." />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#dbe4ff; --muted:#8aa0c7; --accent:#4cc9f0; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.4 ui-sans-serif,system-ui,sans-serif}
    #map{height:100vh;width:100vw}
    .pulse{width:16px;height:16px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 0 rgba(76,201,240,.7);animation:pulse 1.4s ease-out 1;border:2px solid white}
    @keyframes pulse{0%{transform:scale(.6);box-shadow:0 0 0 0 rgba(76,201,240,.7)}70%{transform:scale(1.7);box-shadow:0 0 0 14px rgba(76,201,240,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(76,201,240,0)}}
  </style>
</head>
<body>
<div id="map"></div>
<script>
  const map = L.map('map').setView([20, 0], 2.2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 6, minZoom: 2 }).addTo(map);
  const pingLayer = L.layerGroup().addTo(map);

  const firebaseConfig = {
    apiKey: "AIzaSyBiWkhU2yiIaWN27E0W6EjcR05oOPnlsm8",
    authDomain: "worldping-ff769.firebaseapp.com",
    databaseURL: "https://worldping-ff769-default-rtdb.firebaseio.com",
    projectId: "worldping-ff769",
    storageBucket: "worldping-ff769.firebasestorage.app",
    messagingSenderId: "917984247070",
    appId: "1:917984247070:web:5a5741bbc8690ca6e99d0f",
    measurementId: "G-54W4J6697X"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function flagEmoji(countryCode){
    if(!countryCode) return '🏳️';
    const codePoints = countryCode.toUpperCase().split('').map(c => 127397 + c.charCodeAt());
    return String.fromCodePoint(...codePoints);
  }

  function addPing({lat, lon, country, country_code, city, ip}){
    const latLng = [lat, lon];
    const div = L.divIcon({ className:'', html:'<div class="pulse" title="'+country+'"></div>', iconSize:[16,16], iconAnchor:[8,8] });
    const marker = L.marker(latLng, { icon: div, zIndexOffset: 9999 }).addTo(pingLayer);
    setTimeout(()=> pingLayer.removeLayer(marker), 1600);
  }

  async function sendVisitorPing(){
    try {
      const res = await fetch('https://ipwho.is/');
      const j = await res.json();
      if(!j.success) throw new Error('Geo failed');
      const data = { lat:j.latitude, lon:j.longitude, country:j.country, country_code:j.country_code, city:j.city, ip:j.ip, ts:Date.now() };
      addPing(data);
      db.ref('pings').push(data);
    } catch(e){ console.error(e); }
  }

  db.ref('pings').on('child_added', snapshot => {
    const ping = snapshot.val();
    addPing(ping);
  });

  sendVisitorPing();
</script>
</body>
</html>
